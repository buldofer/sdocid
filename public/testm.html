<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>SCANDOC</title> <script type="text/javascript" src="./js/jquery-1.7.2.min.js"></script> <script type="text/javascript" src="./js/tesseract.js"></script> <link rel="stylesheet" href="./css/cropper.css"> <link rel="stylesheet" href="./css/main.css" type="text/css" media="all"> <link rel="stylesheet" href="./css/bulma.min.css" type="text/css" media="all"> </head> <body> <div id="cuadromrz" class="is-centered" align="center"> <img id="phototest" src="http://192.168.0.36:81/public/img/dnimio.jpg" width="200" height="300" style="vertical-align:middle" alt=" "> <select id="mySelect" onchange="getOption()"> <option value="http://192.168.0.36:81/public/img/dnimio.jpg">MiDni</option> <option value="http://192.168.0.36:81/public/img/pc.jpg">PassCarolina</option> <option value="http://192.168.0.36:81/public/img/passco.jpg">PassColombia</option> <option value="http://192.168.0.36:81/public/img/test1.jpg">Test1</option> </select> 	 <div id="resultado"></div> <div class="camera"> <video id="video">El vídeo de la camara no está disponible...</video> </div> <canvas id="canvas"></canvas> <p id="demo"></p> <div id="transcription"></div> <div id="salida"> <img id="photo" alt=" "> </div> <div id="errores"></div> <progress id="procesobusquedamrz" class="progress is-large is-info" max="100"></progress> <div id="botones" align="center"> <!-- <button id="tomadedatos" class="button"></button> --> <input id="testtest" class="button"onclick="tesstest()" /> <label for="testtest" id="labeltesttest" class="button"></label> 	 <input type="file" id="buscarimagen" class="button" multiple="multiple" onchange="load_file()" /> <label for="buscarimagen" id="labelbuscarimagen" class="button"></label> <!--			<img id="thumbnil" style="width:20%; margin-top:10px; display: none;" alt="image" /> <button id="capturaarchivo" class="button">Capturar archivo</button> <button id="agregardoc" class="button is-rounded botones" style="margin-top: 10px; margin-bottom: 10px; background-color:red; text-decoration-color: black;width: 75%;" onClick="agregardocumento()"> Agregar documento </button> <button id="startbutton" class="button is-rounded botones" style="margin-top: 15px; margin-bottom: 15px; background-color: lightblue; text-decoration-color: white; width: 75%;"></button> <button id="resetformulario" class="button is-rounded botones" style="margin-top: 10px; margin-bottom: 10px; background-color:red; text-decoration-color: black;width: 75%;" onClick="resetformularioClick()"></button> <button id="crearxml" class="button is-rounded botones" style="margin-top: 10px; margin-bottom: 10px; background-color:red; text-decoration-color: black;width: 75%;" onClick="crearficherosxml()"> Crear XML </button> <form name="form" id="form" hidden> <textarea type="hidden" name="base64" id="base64"></textarea> <input type="submit" /> </form> --> </div> <!-- --> <table class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth is-center" align="center" id="tablamrz" style="display: none"> <tbody align="center"> <tr> <td> <img id="thumbnil" style="width:100%; margin-top:10px; display: none;" alt="image" /> </td> </tr> <tr> <td>Tipo de documento</td> <td id="documentType"></td> </tr> <tr> <td>País</td> <td id="issuer"></td> </tr> <tr> <td>Nombre</td> <td id="otherNames"></td> </tr> <tr> <td>Apellidos</td> <td id="lastName"></td> </tr> <tr> <td>Número de documento</td> <td id="documentNumber"></td> </tr> <tr> <td>Nacionalidad</td> <td id="nationality"></td> </tr> <tr> <td>Fecha nacimiento</td> <td id="birthDate"></td> </tr> <tr> <td>Sexo</td> <td id="sex"></td> </tr> <tr> <td>Fecha caducidad documento</td> <td id="expiryDate"></td> </tr> <tr> <td>Número documento</td> <td id="personalNumber"></td> </tr> </tbody> </table> <div id="contenedorlienzofirma"> <p>Firmar Documento:</p> <div id="lienzo"></div> <input name="guardar" type="button" value="guardar" onclick="guardarfirma();"> </div> <!--	<button id="verpartepantalla1" class="button is-rounded botones"	style="margin-top: 10px; margin-bottom: 10px; background-color:red; text-decoration-color: black;width: 75%;" onclick="verpartepantalla()"> Ver Parte del Viajero </button> --> </div> <script src="./js/jquery-3.3.1.slim.min.js"></script> <script src="./js/jquery-3.4.1.min.js"></script> <script src="./js/bootstrap.min.js"></script> <script src="./js/cropper.js"></script> <script src="./js/bootstrap.min.js"></script> <script> 			var photo = document.getElementById('photo'); var salida = document.getElementById('salida'); var video = document.getElementById('video'); var tablamrz = document.getElementById('tablamrz'); var canvas = document.getElementById('canvas'); var startbutton = document.getElementById('startbutton'); var capturaarchivo = document.getElementById('capturaarchivo'); var procesobusquedamrz1 = document.getElementById('procesobusquedamrz'); 			 			var x; 			 			var xxx; function getOption() { 			x = document.getElementById('mySelect').value; xxx = x; // alert(xxx); 			 			 document.getElementById('phototest').src = xxx; 			 			 			 tesstest(); } 		 window.Tesseract = Tesseract.create({ // Path to worker workerPath: 'http://192.168.0.36:81/public/js/worker.js', // Path of folder where the language trained data is located // note the "/" at the end, this string will be concatenated with the selected language langPath: 'http://192.168.0.36:81/public/lang/', // Path to index script of the tesseract core ! https://github.com/naptha/tesseract.js-core corePath: 'http://192.168.0.36:81/public/js/index.js', }); // https://apps.fomento.gob.es/crgt/servlet/ServletController?modulo=datosconsulta&tpsolic=M&accion=consultar_nif&consulta=2687-HRL&nocaptcha=si&btnOk=Consultar /* xhttp.setRequestHeader("Content-Type", "application/json; charset=UTF-8"); xhttp.setRequestHeader("Access-Control-Allow-Origin", "*"); xhttp.setRequestHeader("Access-Control-Allow-Methods", "GET, POST, PUT, OPTIONS"); xhttp.setRequestHeader("Access-Control-Allow-Headers", "Content-Type"); xhttp.setRequestHeader("Access-Control-Request-Headers", "X-Requested-With, accept, content-type"); */ function load_file() { photo.style.display = "block"; var reader = new FileReader(); reader.onload = function () { var img = null; img = new Image(); img.src = reader.result; img.onload = function () { document.getElementById('resultado').innerHTML = ''; // document.getElementById('resultado').appendChild(img); img.style.display = "block"; img.setAttribute('id', 'imagenfichero'); photo.setAttribute('src', img.src); // continuarescaneando(); document.getElementById('resultado').style.display = "block"; salida.style.display = "block"; video.style.display = "none"; /* buscarimagen.style.display = "none"; 	 labelbuscarimagen.style.display = "none"; */ // tomadedatos.style.display = "none"; continuarescaneando(); }; }; reader.readAsDataURL(document.getElementById('buscarimagen').files[0]); //continuarescaneando(); } function continuarescaneando() { cropper = new Cropper(photo, { dragMode: 'none', viewMode: 1, autoCropArea: 1, background: false, zoomable: false, zoomOnWheel: false, restore: false, guides: false, center: false, highlight: true, cropBoxMovable: false, cropBoxResizable: false, toggleDragModeOnDblclick: false, }); cropper.crop(); photo.addEventListener('crop', function () { var canvascropped = cropper.getCroppedCanvas(); canvascropped.imageSmoothingQuality = "high"; tess(canvascropped, 1); procesobusquedamrz1.style.display = "block"; }); //cropper.reset(); } function cleanText(string) { var specialChars = "!@#$^&%*()+=-[]\/{}|_>:?,.¡¿'`´ "; for (var i = 0; i < specialChars.length; i++) { string = string.replace(new RegExp('\\' + specialChars[i], 'gm'), ''); } // string = string.replace(/([\r\n\\])+/g, ''); // string = string.replace(/([\\])+/gm, ''); // (/^[A-Z0-9<]{30,90}$/gm); string = string.replace(/([\r])+/gm, ""); return string; } /* function cleanText(string) { var specialChars = "!@#$^&%*()+=-[]\/{}|_>:?,.¡¿'`´ "; for (var i = 0; i < specialChars.length; i++) { string = string.replace(new RegExp('\\' + specialChars[i], 'gm'), ''); } string = string.replace(/([\r\n\\])+/g, ''); return string; } */ splitString = function(string, splitters) { var list = [string]; for(var i=0, len=splitters.length; i<len; i++) { traverseList(list, splitters[i], 0); } return flatten(list); } traverseList = function(list, splitter, index) { if(list[index]) { if((list.constructor !== String) && (list[index].constructor === String)) (list[index] != list[index].split(splitter)) ? list[index] = list[index].split(splitter) : null; (list[index].constructor === Array) ? traverseList(list[index], splitter, 0) : null; (list.constructor === Array) ? traverseList(list, splitter, index+1) : null; } } flatten = function(arr) { return arr.reduce(function(acc, val) { return acc.concat(val.constructor === Array ? flatten(val) : val); },[]); } function tesstest(){ // Convert an image to text. This task works asynchronously, so you may show 			// your user a loading dialog or something like that, or show the progress with Tesseract let tesseractSettings = { lang: 'mrz' }; 			 						 			Tesseract.recognize(xxx, tesseractSettings).then(function (result) { 			document.getElementById('transcription').style.display = "block"; 			procesobusquedamrz1.style.display = "block"; 			var textolimpio = cleanText(result.text); 			var ficheross; 			console.log(" TODO EL TEXTO " + textolimpio); 			 			 			ficheross = JSON.stringify(textolimpio); 			 			var ficherossx; 			 			console.log(ficheross); 			 			ficherossx = JSON.parse(ficheross); 			 			var ress = ficherossx.split("\\n"); 			 			 var fichs = JSON.stringify(ress); 			 			 var cars = [fichs]; 				 			 console.log(ress); 			 			 console.log(fichs); 			 			 console.log(cars); 			 			var stringToSplit = ficherossx; var splitList = ["\\n"]; var kakass = splitString(stringToSplit, splitList); 	 console.log(kakass.toString().split('\\')); 	 var res =kakass.toString().split('\n'); var str2 = ''; var i; var contador = 0; for (i = 0; i < res.length; i++) { // str2 += ''+contador +':' + ''+res[i]+''; 	 str2 += ''+':' +res[i]; 	// str2 += res[i]; contador = contador+1; if (i != res.length-1) { // str2 += ","; } 							} 							 	var res2 = str2.split(':'); 	 	console.log(res2); 	 	//var fichsres2 = JSON.parse(res2); 	//console.log(fichsres2); 	 var textolimpiozz = cleanText(kakass.toString());						 	 var lineasmrzzz = textolimpiozz.match(/([\w<]{1}[A-Z0-9<]{15,44}[<]{2}[A-Z0-9<]+)/g); /// ojo, con el valor del primer campo de lo siguiente se regula la detección!!! //var lineasmrzzz = textolimpiozz.match(/([\w<]{1}[A-Z0-9<]{15,44}[<]{2}[A-Z0-9<]+)/g); /// ojo, con el valor del primer campo de lo siguiente se regula la detección!!! //var lineasmrzzz = textolimpiozz.match(/([\w<]{1}[A-Z0-9<]{15,44}[<]{2}[A-Z0-9<]+)/g); /// ojo, con el valor del primer campo de lo siguiente se regula la detección!!! //var lineasmrzzz = textolimpiozz.match(/([\w<]{1}[A-Z0-9<]{15,44}[<]{2}[A-Z0-9<]+)/g); /// ojo, con el valor del primer campo de lo siguiente se regula la detección!!! console.log("Match encontrado: " + lineasmrzzz); console.log("Match encontrado 0: " + lineasmrzzz[0].replace('\\','')); console.log("Match encontrado 1: " + lineasmrzzz[1]); console.log("Match encontrado 2: " + lineasmrzzz[2]); testnode(lineasmrzzz[0], lineasmrzzz[1], lineasmrzzz[2]); 	return res2; 	 	}); } function tess(canvaaa, control) { var resultadodefinitivo; if (control === 1) { let tesseractSettings = { lang: 'mrz' }; // Convert an image to text. This task works asynchronously, so you may show // your user a loading dialog or something like that, or show the progress with Tesseract Tesseract.recognize(canvaaa, tesseractSettings).then(function (result) { // The result object of a text recognition contains detailed data about all the text // recognized in the image, words are grouped by arrays etc //document.getElementById('tabladoc').style.display = "block"; document.getElementById('transcription').style.display = "block"; procesobusquedamrz1.style.display = "block"; var textolimpio = cleanText(result.text); // var textolimpio = result.text; // textolimpio = textolimpio.replace(/\n/, ''); // textolimpio = textolimpio.replace(/\n/, ''); // var hh = check(cleanText(result.text)); //console.log(" Valor de hh: " + hh); console.log(" TODO EL TEXTO " + textolimpio); document.getElementById('transcription').innerText = textolimpio; // var lineasmrz = textolimpio.match(/.+((\w<[<]{1,}\w*)|.+(\d<[<]{1,}\d*$){30,44})/gmi); // var lineasmrz = textolimpio.match(/.+([A-Z0-9])+[<]+([^A-Z0-9])+[<].+/g); // var lineasmrz = textolimpio.match(/.+([A-Z0-9])[<]+([0-9])*[<].+/gm); // var lineasmrz = textolimpio.match(/.+([A-Z0-9])*[<]+([0-9])*[<].+/gm); // var lineasmrz = textolimpio.match(/.+([A-Z0-9])[<]+([0-9])*[<].+/gm); /// ojo!!!! ((\w.+<[<]{1,}\w.+))|[A-Z0-9].+[<][A-Z0-9<]{30,44}$ (este parece el correcto) o este ([^A-Z0-9])([A-Z0-9<]){30,44}$ o este ^([^\w]+[^A-Z0-9])*([A-Z0-9<]){30,44}$ /// o esta \b(.[0-9<])([A-Z0-9<]){30,44}$ o este .+[<]{2,}.+$ // var lineasmrz = textolimpio.match(/.+([A-Z0-9])[<]+([0-9])*[<].+/gm); // var lineasmrz = textolimpio.match(/([^A-Z0-9])([A-Z0-9<]){30,44}$/gm); // var lineasmrz = textolimpio.match(/^([^\w]+[^A-Z0-9])*([A-Z0-9<]){30,44}$/gm); /// este a ver.. ^([A-Z0-9<]([<]{1,})*){30,44}$ o este ((.+[<]{1,}).+([A-Z0-9<])|\d([<]{1,})*([A-Z0-9<]){30,44}$) o esta ((.+[<]{2,}).([A-Z0-9<])|\d([<]{2,})([A-Z0-9<]){30}$).+ //var lineasmrz = textolimpio.match(/((.+[<]{2,}).([A-Z0-9<])|\d([<]{2,})([A-Z0-9<]){30}$).+/gm); /// ([A-Z0-9].+[<].+) // \b([A-Z0-9<]{30,44}[<].+$) // var lineasmrz = textolimpio.match(/([A-Z0-9].+[<].+)/gm); /// este es el bueno ^[A-Z0-9<]{30,90}$ // var textolimpio = textolimpio.match(/^[A-Z0-9<]{30,90}$/gm); // textolimpio.match(/^(^PIC)|[A-Z0-9<]{30,44}$/gm).replace(/.+(?=ID|(P<\b))/, ''); // var lineasmrz = textolimpio.match(/^(^PIC)|[A-Z0-9<]{30,44}$/gm); // este es el casi bueno... var lineasmrz = textolimpio.match(/\b([A-Z[A-Z0-9<]{30,44}?[<][A-Z0-9<]+)|([A-Z0-9<]{30,44})/g); var lineasmrz = textolimpio.match(/\b([A-Z[A-Z0-9<]{18,44}[<][A-Z0-9<]+)/g); /// ojo, con el valor del primer campo de lo siguiente se regula la detección!!! 							 							 							 							//lineasmrz.replace(/.+(?=ID|(P<\b))/, ''); // var lineasmrz = textolimpio.match(/[A-Z0-9<]{30,44}/g); //¡¡ var lineasmrz = lineasmrzraw.match(/[A-Z0-9].+[<].+[^A-Z0-9].+[<].+/mg); // var lineasmrz = textolimpio.match(/(.+[A-Z0-9]+[<][<]|([<]+[<]){30,}).+/gm); console.log("Match encontrado: " + lineasmrz); console.log("Match encontrado 0: " + lineasmrz[0]); console.log("Match encontrado 1: " + lineasmrz[1]); console.log("Match encontrado 2: " + lineasmrz[2]); var linea1 = lineasmrz[0]; var linea2 = lineasmrz[1]; // var linea3 = cleanText(lineasmrz[2]); if (!lineasmrz[2]) { var linea3 = ''; } else { var linea3 = lineasmrz[2]; // var regex = /([A-Z0-9<]{30,44}$)/; // var match1, match2, match3, matchlimpio1, matchlimpio2, matchlimpio3; // match1 = regex.exec(linea1); // match2 = regex.exec(linea2); // match3 = regex.exec(linea3); // testnode(linea1, linea2, linea3); // matchlimpio1 = match1[0]; // matchlimpio2 = match2[0]; // matchlimpio3 = match3[0]; // matchlimpio1 = matchlimpio1.replace(/.+(?=ID|(P<\b))/, ''); // matchlimpio2 = matchlimpio2.replace(/.+(?=ID|(P<\b))/, ''); // matchlimpio3 = matchlimpio3.replace(/.+(?=ID|(P<\b))/, ''); // rematchlimpio = rematchlimpio.replace(/.+(?=ID|(P<\b))/, ''); // linea1 = matchlimpio1; // linea2 = matchlimpio2; // linea3 = matchlimpio3; // console.log("matchlimpio1 : " + matchlimpio1); // console.log("matchlimpio2 : " + matchlimpio2); // console.log("matchlimpio3 : " + matchlimpio3); // console.log("matchlimpio : " + rematchlimpio); // I'm Jack, or johnny, but I prefer Jack. // document.getElementById('transcription').innerText = rematchlimpio+ " Tamaño : " + rematchlimpio.length.toString() ; // console.log("transcription: " + rematchlimpio + " Tamaño : " + rematchlimpio.length.toString()); } var resultadolineas = linea1 + '\n\r' + linea2 + '\n\r' + linea3; // var resultadolineas = linea1 + '\n\r' + linea2 + '\n\r' + linea3; // var string = 'I<UTOD23145890<1233<<<<<<<<<<<' + '\r\n' + '7408122F1204159UTO<<<<<<<<<<<6' + '\r\n' + // 'ERIKSSON<<ANNA<MARIA<<<<<<<<<<'; // var resultadolineas = '' + linea1 + '' + '\r\n' + '' + linea2 + '' + '\r\n' + linea3 + ''; console.log("resultado para en envío: " + resultadolineas); testnode(linea1, linea2, linea3); /* var matchlimpio; if (match != null) { matchlimpio = match; var rematchlimpio; rematchlimpio = matchlimpio; rematchlimpio = rematchlimpio.replace(/.+(?=ID|(P<\b))/, ''); console.log("matchlimpio : " + rematchlimpio); // I'm Jack, or johnny, but I prefer Jack. // document.getElementById('transcription').innerText = rematchlimpio+ " Tamaño : " + rematchlimpio.length.toString() ; console.log("transcription: " + rematchlimpio + " Tamaño : " + rematchlimpio.length.toString()); // CosultaMrz(rematchlimpio); } else { console.log("match es nulo"); // I'm Jack, or johnny, but I prefer Jack. } */ // photo.style.display = "none"; }); } else if (control === 0) { document.getElementById('transcription').innerText = "Documento encontrado"; } } function testnode(linea1, linea2, linea3) { //	dbdd.inquilinos.clear(); var xmlhttp = new XMLHttpRequest(); if (window.XMLHttpRequest) { // Objeto para IE7+, Firefox, Chrome, Opera, Safari xmlhttpx = new XMLHttpRequest(); } else { // Objeto para IE6, IE5 xmlhttpx = new ActiveXObject("Microsoft.XMLHTTP"); } var ficheros; xmlhttp.onreadystatechange = function () { if (this.readyState == 4 && this.status == 200) { ficheros = JSON.parse(this.response); // console.log(ficheros['fields']['firstName']); console.log(ficheros); document.getElementById('demo').innerText = ficheros['fields']['firstName'] + "\n\r" + ficheros['fields']['lastName'] + "\n\r" + ficheros['fields']['documentNumber'] + "\n\r" + ficheros['fields']['birthDate'] + "\n\r" + ficheros['fields']['nationality'] + "\n\r" + ficheros['fields']['optional1'] + "\n\r" + ficheros['fields']['sex'] + "\n\r" + ficheros['fields']['documentCode'] ; } }; if (!linea3) { var cadenaurlconsultamrz = "https://us-central1-scandoc-834fe.cloudfunctions.net/app/" + linea1 + "/" + linea2; } else { var cadenaurlconsultamrz = "https://us-central1-scandoc-834fe.cloudfunctions.net/app/" + linea1 + "/" + linea2 + "/" + linea3; } var cadenaurlconsultamrzlimpia = decodeURI(cadenaurlconsultamrz); xmlhttp.open("GET", cadenaurlconsultamrzlimpia, true); xmlhttp.send(); } </script> </body> </html>